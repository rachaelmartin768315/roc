on:
  pull_request:
  
name: CI manager

jobs:
    check-changes:
        runs-on: ubuntu-22.04
        outputs:
            run_tests: ${{ steps.filecheck.outputs.run_tests }}
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: Check for only .md changes
              id: filecheck
              run: |
                git fetch origin ${{ github.base_ref }}
                if git diff --name-only origin/${{ github.base_ref }} HEAD | grep -qvE '(\.md$)'; then
                    echo "run_tests=full" >> $GITHUB_OUTPUT
                else
                    echo "run_tests=none" >> $GITHUB_OUTPUT
                fi

            - run: echo "debug output ${{ steps.filecheck.outputs.run_tests }}"

    start-nix-linux-x86-64-tests:
        needs: check-changes
        if: needs.check-changes.outputs.run_tests == 'full'
        uses: ./.github/workflows/nix_linux_x86_64.yml

    start-nix-macos-apple-silicon-tests:
        needs: check-changes
        if: needs.check-changes.outputs.run_tests == 'full'
        uses: ./.github/workflows/nix_macos_apple_silicon.yml

    finish-full:
        runs-on: ubuntu-22.04
        needs: [start-nix-linux-x86-64-tests, start-nix-macos-apple-silicon-tests]
        steps:
            - run: echo "all workflows succeeded!"

    finish-none:
        runs-on: ubuntu-22.04
        needs: [check-changes]
        if: needs.check-changes.outputs.run_tests == 'none'
        steps:
            - run: echo "Only non-code files changed. CI manager did not run any workflows."
  